<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Task-aware Design Copilot</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      color: #e0e0e0;
      background: #1e1e1e;
      padding: 16px;
    }

    h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #ffffff;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #e0e0e0;
      border-bottom: 1px solid #3a3a3a;
      padding-bottom: 6px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #b0b0b0;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
      background: #2a2a2a;
      color: #e0e0e0;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #0B63F6;
      background: #2d2d2d;
    }

    input[type="text"]::placeholder,
    textarea::placeholder {
      color: #666;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .required {
      color: #d32f2f;
      margin-left: 2px;
    }

    button {
      width: 100%;
      padding: 10px 16px;
      background: #0B63F6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 8px;
    }

    button:hover {
      background: #0952cc;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background: #2a2a2a;
      color: #e0e0e0;
      border: 1px solid #3a3a3a;
    }

    button.secondary:hover {
      background: #333333;
    }

    .selection-status {
      padding: 8px 12px;
      background: #1a2a3a;
      border: 1px solid #2a4a6a;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 12px;
      color: #5a9fd4;
    }

    .selection-status.none {
      background: #3a2a1a;
      border-color: #6a5a2a;
      color: #e8a040;
    }

    /* Loading state */
    .loading {
      display: none;
      padding: 20px;
      text-align: center;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 16px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0B63F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    /* Results sections */
    .results {
      display: none;
      margin-top: 20px;
    }

    .results.active {
      display: block;
    }

    .result-section {
      margin-bottom: 24px;
    }

    .flow-list, .improvement-list, .pattern-list, .wcag-list, .notes-list {
      margin-left: 16px;
    }

    .flow-list li,
    .notes-list li {
      margin-bottom: 6px;
      color: #b0b0b0;
    }

    .improvement-item,
    .pattern-item,
    .wcag-item {
      background: #252525;
      border-left: 3px solid #0B63F6;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .improvement-item h4,
    .pattern-item h4,
    .wcag-item h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #ffffff;
    }

    .improvement-item p,
    .pattern-item p,
    .wcag-item p {
      font-size: 12px;
      margin-bottom: 4px;
      color: #b0b0b0;
    }

    .component-tag {
      display: inline-block;
      background: #1a3a5a;
      color: #7ab8e8;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      margin-right: 4px;
      margin-top: 4px;
      font-family: 'Courier New', monospace;
    }

    .pattern-actions {
      margin-top: 8px;
    }

    .pattern-actions button {
      width: auto;
      padding: 6px 12px;
      font-size: 11px;
    }

    .error {
      background: #3a1a1a;
      border: 1px solid #8a4a4a;
      color: #ff8a80;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .error h4 {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .hidden {
      display: none;
    }

    /* Summary Bar */
    .summary-bar {
      background: #252525;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 11px;
      color: #b0b0b0;
      display: none;
    }

    .summary-bar.active {
      display: block;
    }

    .summary-bar-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .summary-label {
      color: #666;
      font-weight: 500;
    }

    .summary-value {
      color: #e0e0e0;
    }

    .summary-badge {
      background: #1a3a5a;
      color: #7ab8e8;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }

    /* Tabs */
    .tabs {
      display: none;
      border-bottom: 1px solid #3a3a3a;
      margin-bottom: 16px;
    }

    .tabs.active {
      display: flex;
    }

    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: #b0b0b0;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 500;
      margin: 0;
      width: auto;
    }

    .tab:hover {
      color: #e0e0e0;
      background: #252525;
    }

    .tab.active {
      color: #0B63F6;
      border-bottom-color: #0B63F6;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Split view for Recommendations */
    .split-view {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 16px;
      min-height: 300px;
    }

    .pattern-list-sidebar {
      border-right: 1px solid #3a3a3a;
      padding-right: 12px;
    }

    .pattern-list-item {
      padding: 8px 10px;
      background: #252525;
      border-radius: 4px;
      margin-bottom: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .pattern-list-item:hover {
      background: #2a2a2a;
    }

    .pattern-list-item.active {
      background: #1a2a3a;
      border-left-color: #0B63F6;
      color: #7ab8e8;
    }

    .pattern-detail-panel {
      padding-left: 12px;
    }

    .pattern-detail-empty {
      color: #666;
      text-align: center;
      padding: 60px 20px;
      font-size: 12px;
    }

    /* Flow chips */
    .flow-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .flow-chip {
      background: #252525;
      border: 1px solid #3a3a3a;
      border-radius: 16px;
      padding: 4px 12px;
      font-size: 12px;
      color: #e0e0e0;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .flow-chip:hover {
      background: #2a2a2a;
      border-color: #0B63F6;
    }

    .flow-chip.editing {
      background: #1a2a3a;
      border-color: #0B63F6;
    }

    .flow-chip-number {
      background: #3a3a3a;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .compact-section {
      margin-bottom: 20px;
    }

    .compact-section h4 {
      font-size: 12px;
      color: #b0b0b0;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Input Form -->
    <div id="input-section">
      <h2>Task Context</h2>

      <div id="selection-status" class="selection-status none">
        Detecting selection...
      </div>

      <label>Primary Task <span class="required">*</span></label>
      <input type="text" id="primaryTask" placeholder="e.g., User signs in" required>

      <label>Secondary Task</label>
      <input type="text" id="secondaryTask" placeholder="e.g., Reset password">

      <label>Persona</label>
      <input type="text" id="persona" placeholder="e.g., New desktop user">

      <label>Constraints</label>
      <textarea id="constraints" placeholder="e.g., Use Material Web components; minimal form"></textarea>

      <label>System Prompt (optional)</label>
      <textarea id="systemPrompt" placeholder="Custom instructions for the AI..."></textarea>

      <button id="captureBtn" class="secondary">🔄 Refresh selection</button>
      <button id="analyzeBtn">Review & Recommend Designs</button>
      <p style="font-size: 11px; color: #666; text-align: center; margin-top: 6px; margin-bottom: 0;">
        Get UX recommendations, patterns, and generate components.
      </p>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Analyzing design...</div>
    </div>

    <!-- Error Display -->
    <div id="error" class="error hidden">
      <h4>Error</h4>
      <p id="errorMessage"></p>
    </div>

    <!-- Results with Summary Bar and Tabs -->
    <div id="results" class="results">
      <h2>Analysis Results</h2>

      <!-- Summary Bar -->
      <div id="summary-bar" class="summary-bar">
        <div class="summary-bar-grid">
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <div class="summary-item">
              <span class="summary-label">Task:</span>
              <span class="summary-value" id="summary-task">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-badge">Material Web</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Components:</span>
              <span class="summary-value" id="summary-components">0</span>
            </div>
          </div>
          <div class="summary-item">
            <span class="summary-label" id="summary-timestamp">-</span>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <button id="addNotesBtn" class="secondary">📝 Add notes to canvas</button>

      <!-- Tabs -->
      <div id="tabs" class="tabs">
        <button class="tab active" data-tab="flows">Flows</button>
        <button class="tab" data-tab="recommendations">Recommendations</button>
        <button class="tab" data-tab="accessibility">Accessibility</button>
      </div>

      <!-- Tab Content: Flows -->
      <div id="tab-flows" class="tab-content active">
        <div class="compact-section">
          <h4>Primary Flow</h4>
          <div id="flows-primary" class="flow-chips"></div>
        </div>
        <div class="compact-section">
          <h4>Secondary Flow</h4>
          <div id="flows-secondary" class="flow-chips"></div>
        </div>
        <div class="compact-section">
          <h4>Edge Cases</h4>
          <div id="flows-edge" class="flow-chips"></div>
        </div>
      </div>

      <!-- Tab Content: Recommendations (merged improvements + components) -->
      <div id="tab-recommendations" class="tab-content">
        <div id="recommendations-content"></div>
      </div>

      <!-- Tab Content: Accessibility -->
      <div id="tab-accessibility" class="tab-content">
        <div id="wcag-content"></div>
      </div>
    </div>
  </div>

  <script>
    console.log('[UI] ui.ts is loading...');

    // State
    let currentSnapshot = null;
    let currentResults = null;
    let analysisTimestamp = null;

    console.log('[UI] Waiting for DOM...');

    // DOM Elements
    let primaryTaskInput;
    let secondaryTaskInput;
    let personaInput;
    let constraintsInput;
    let systemPromptInput;
    let captureBtn;
    let analyzeBtn;
    let addNotesBtn;
    let selectionStatus;
    let inputSection;
    let loadingSection;
    let loadingText;
    let errorSection;
    let errorMessage;
    let resultsSection;
    let summaryBar;
    let summaryTask;
    let summaryComponents;
    let summaryTimestamp;
    let tabs;
    let tabButtons;
    let flowsPrimary;
    let flowsSecondary;
    let flowsEdge;
    let recommendationsContent;
    let wcagContent;

    function initializeDOM() {
      console.log('[UI] Initializing DOM elements...');

      primaryTaskInput = document.getElementById('primaryTask');
      secondaryTaskInput = document.getElementById('secondaryTask');
      personaInput = document.getElementById('persona');
      constraintsInput = document.getElementById('constraints');
      systemPromptInput = document.getElementById('systemPrompt');
      captureBtn = document.getElementById('captureBtn');
      analyzeBtn = document.getElementById('analyzeBtn');
      addNotesBtn = document.getElementById('addNotesBtn');
      selectionStatus = document.getElementById('selection-status');
      inputSection = document.getElementById('input-section');
      loadingSection = document.getElementById('loading');
      loadingText = document.getElementById('loadingText');
      errorSection = document.getElementById('error');
      errorMessage = document.getElementById('errorMessage');
      resultsSection = document.getElementById('results');
      summaryBar = document.getElementById('summary-bar');
      summaryTask = document.getElementById('summary-task');
      summaryComponents = document.getElementById('summary-components');
      summaryTimestamp = document.getElementById('summary-timestamp');
      tabs = document.getElementById('tabs');
      tabButtons = document.querySelectorAll('.tab');
      flowsPrimary = document.getElementById('flows-primary');
      flowsSecondary = document.getElementById('flows-secondary');
      flowsEdge = document.getElementById('flows-edge');
      recommendationsContent = document.getElementById('recommendations-content');
      wcagContent = document.getElementById('wcag-content');

      console.log('[UI] DOM elements initialized successfully');

      // Load persisted draft state
      loadDraftState();
    }

    // Draft state persistence (in-memory only - localStorage not available in Figma plugins)
    let draftState = {
      primaryTask: '',
      secondaryTask: '',
      persona: '',
      constraints: '',
      systemPrompt: '',
      activeTab: 'flows'
    };

    function saveDraftState() {
      try {
        draftState = {
          primaryTask: primaryTaskInput.value,
          secondaryTask: secondaryTaskInput.value,
          persona: personaInput.value,
          constraints: constraintsInput.value,
          systemPrompt: systemPromptInput.value,
          activeTab: document.querySelector('.tab.active')?.dataset.tab || 'flows'
        };
      } catch (e) {
        console.log('[UI] Failed to save draft state:', e);
      }
    }

    function loadDraftState() {
      // In-memory state only - no localStorage in Figma plugins
      console.log('[UI] Draft state loaded (in-memory only)');
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        const contentTabName = content.id.replace('tab-', '');
        content.classList.toggle('active', contentTabName === tabName);
      });

      // Save active tab
      saveDraftState();
    }

    // Summary bar
    function updateSummaryBar(primaryTask, componentCount) {
      summaryTask.textContent = primaryTask.substring(0, 40) + (primaryTask.length > 40 ? '...' : '');
      summaryComponents.textContent = componentCount;

      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      summaryTimestamp.textContent = timeStr;

      summaryBar.classList.add('active');
      tabs.classList.add('active');
    }

    function updateSelectionStatus(snapshot) {
      if (snapshot) {
        selectionStatus.className = 'selection-status';
        selectionStatus.textContent = `✓ Captured: "${snapshot.title}" - ${snapshot.selectionSummary.nodeCount} nodes`;
      } else {
        selectionStatus.className = 'selection-status none';
        selectionStatus.textContent = 'No selection captured. Click "Use current selection" to capture your design.';
      }
    }

    function showLoading(message) {
      inputSection.style.display = 'none';
      resultsSection.classList.remove('active');
      errorSection.classList.add('hidden');
      loadingSection.classList.add('active');
      loadingText.textContent = message;
    }

    function hideLoading() {
      loadingSection.classList.remove('active');
      inputSection.style.display = 'block';
    }

    function showError(error) {
      hideLoading();
      errorSection.classList.remove('hidden');
      errorMessage.textContent = error;
    }

    function hideError() {
      errorSection.classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderFlows(flows) {
      // Primary flow chips
      flowsPrimary.innerHTML = '';
      flows.primary.forEach((step, idx) => {
        const chip = document.createElement('div');
        chip.className = 'flow-chip';
        chip.innerHTML = `<span class="flow-chip-number">${idx + 1}</span>${escapeHtml(step)}`;
        chip.onclick = () => console.log('[UI] Flow step clicked:', step);
        flowsPrimary.appendChild(chip);
      });

      // Secondary flow chips
      flowsSecondary.innerHTML = '';
      flows.secondary.forEach((step, idx) => {
        const chip = document.createElement('div');
        chip.className = 'flow-chip';
        chip.innerHTML = `<span class="flow-chip-number">${idx + 1}</span>${escapeHtml(step)}`;
        chip.onclick = () => console.log('[UI] Flow step clicked:', step);
        flowsSecondary.appendChild(chip);
      });

      // Edge case chips
      flowsEdge.innerHTML = '';
      flows.edgeCases.forEach((step, idx) => {
        const chip = document.createElement('div');
        chip.className = 'flow-chip';
        chip.innerHTML = `<span class="flow-chip-number">${idx + 1}</span>${escapeHtml(step)}`;
        chip.onclick = () => console.log('[UI] Flow step clicked:', step);
        flowsEdge.appendChild(chip);
      });
    }

    function renderRecommendations(improvements) {
      let html = '';

      improvements.forEach((improvement, index) => {
        const components = improvement.suggestedComponents || [];

        html += `
          <div class="improvement-item">
            <h4>${index + 1}. ${escapeHtml(improvement.title)}</h4>
            <p><strong>Why:</strong> ${escapeHtml(improvement.rationale)}</p>
            <p><strong>How to apply:</strong> ${escapeHtml(improvement.howToApply)}</p>

            ${components.length > 0 ? `
              <div style="margin-top: 12px; margin-bottom: 8px;">
                <strong style="font-size: 11px; color: #b0b0b0;">Suggested Components:</strong><br>
                ${components.map(c => `<span class="component-tag">${escapeHtml(c)}</span>`).join('')}
              </div>
              <div class="pattern-actions">
                <button class="secondary" data-improvement-index="${index}">
                  ⚡ Insert components
                </button>
              </div>
            ` : ''}
          </div>
        `;
      });

      recommendationsContent.innerHTML = html;

      // Add event listeners for insert buttons
      recommendationsContent.querySelectorAll('button[data-improvement-index]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-improvement-index') || '0');
          const improvement = improvements[index];
          const components = improvement.suggestedComponents || [];

          parent.postMessage({
            pluginMessage: {
              type: 'insert-scaffold',
              patternName: improvement.title,
              components
            }
          }, '*');
        });
      });
    }

    function renderWCAG(wcagNotes) {
      let html = '';

      wcagNotes.forEach(note => {
        html += `
          <div class="wcag-item">
            <h4>⚠️ ${escapeHtml(note.issue)}</h4>
            <p><strong>Issue:</strong> ${escapeHtml(note.detail)}</p>
            <p><strong>Fix:</strong> ${escapeHtml(note.fix)}</p>
          </div>
        `;
      });

      wcagContent.innerHTML = html;
    }

    function displayResults(results) {
      currentResults = results;
      hideLoading();
      hideError();

      // Count total components from improvements
      const componentCount = results.uxImprovements.reduce((total, improvement) => {
        const components = improvement.suggestedComponents || [];
        return total + components.length;
      }, 0);

      // Update summary bar
      updateSummaryBar(primaryTaskInput.value, componentCount);

      // Render all content
      renderFlows(results.flows);
      renderRecommendations(results.uxImprovements);
      renderWCAG(results.wcagNotes);

      resultsSection.classList.add('active');

      // Restore active tab from in-memory draft state
      if (draftState.activeTab) {
        switchTab(draftState.activeTab);
      }
    }

    async function analyzeDesign() {
      const primaryTask = primaryTaskInput.value.trim();

      if (!primaryTask) {
        showError('Primary task is required');
        return;
      }

      hideError();
      showLoading('Analyzing design... This may take up to 15 seconds');

      const payload = {
        primaryTask,
        secondaryTask: secondaryTaskInput.value.trim() || undefined,
        persona: personaInput.value.trim() || undefined,
        constraints: constraintsInput.value.trim() || undefined,
        systemPrompt: systemPromptInput.value.trim() || undefined,
        frameSnapshot: currentSnapshot || undefined
      };

      console.log('[UI] Sending analyze request:', payload);

      try {
        const response = await fetch('http://localhost:4000/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }

        const results = await response.json();
        console.log('[UI] Analysis results received:', results);

        displayResults(results);
      } catch (error) {
        console.error('[UI] Analysis error:', error);
        showError(`Analysis failed: ${error.message || 'Unknown error'}. Make sure the backend server is running on localhost:4000.`);
      }
    }

    function setupEventListeners() {
      console.log('[UI] Setting up event listeners...');

      // Input change listeners for draft state persistence
      primaryTaskInput.addEventListener('input', saveDraftState);
      secondaryTaskInput.addEventListener('input', saveDraftState);
      personaInput.addEventListener('input', saveDraftState);
      constraintsInput.addEventListener('input', saveDraftState);
      systemPromptInput.addEventListener('input', saveDraftState);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tabBtn => {
        tabBtn.addEventListener('click', () => {
          switchTab(tabBtn.dataset.tab);
        });
      });

      captureBtn.addEventListener('click', () => {
        console.log('[UI] Requesting selection capture');
        parent.postMessage({ pluginMessage: { type: 'capture-selection' } }, '*');
      });

      analyzeBtn.addEventListener('click', () => {
        analyzeDesign();
      });

      addNotesBtn.addEventListener('click', () => {
        if (currentResults && currentResults.canvasNotes.length > 0) {
          parent.postMessage({
            pluginMessage: {
              type: 'insert-notes',
              notes: currentResults.canvasNotes
            }
          }, '*');
        }
      });

      console.log('[UI] Event listeners set up successfully');
    }

    // Listen for messages from plugin code
    window.onmessage = (event) => {
      console.log('[UI] Message received:', event);
      const msg = event.data.pluginMessage;
      if (!msg) {
        console.log('[UI] No pluginMessage in event data');
        return;
      }

      console.log('[UI] Plugin message type:', msg.type);

      if (msg.type === 'selection-captured') {
        console.log('[UI] Selection captured, snapshot:', msg.snapshot);
        currentSnapshot = msg.snapshot;
        updateSelectionStatus(currentSnapshot);
      }
    };

    console.log('[UI] Setting up message listener...');

    // Initialize everything when DOM is ready
    if (document.readyState === 'loading') {
      console.log('[UI] DOM not ready yet, waiting...');
      document.addEventListener('DOMContentLoaded', () => {
        console.log('[UI] DOMContentLoaded fired');
        initializeDOM();
        setupEventListeners();
        console.log('[UI] UI fully initialized and listening for messages');
      });
    } else {
      console.log('[UI] DOM already ready');
      initializeDOM();
      setupEventListeners();
      console.log('[UI] UI fully initialized and listening for messages');
    }
  </script>
</body>
</html>
