<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Task-aware Design Copilot</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      color: #e0e0e0;
      background: #1e1e1e;
      padding: 16px;
    }

    h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #ffffff;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #e0e0e0;
      border-bottom: 1px solid #3a3a3a;
      padding-bottom: 6px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #b0b0b0;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
      background: #2a2a2a;
      color: #e0e0e0;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #0B63F6;
      background: #2d2d2d;
    }

    input[type="text"]::placeholder,
    textarea::placeholder {
      color: #666;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .required {
      color: #d32f2f;
      margin-left: 2px;
    }

    button {
      width: 100%;
      padding: 10px 16px;
      background: #0B63F6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 8px;
    }

    button:hover {
      background: #0952cc;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.secondary {
      background: #2a2a2a;
      color: #e0e0e0;
      border: 1px solid #3a3a3a;
    }

    button.secondary:hover {
      background: #333333;
    }

    .selection-status {
      padding: 8px 12px;
      background: #1a2a3a;
      border: 1px solid #2a4a6a;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 12px;
      color: #5a9fd4;
    }

    .selection-status.none {
      background: #3a2a1a;
      border-color: #6a5a2a;
      color: #e8a040;
    }

    /* Loading state */
    .loading {
      display: none;
      padding: 20px;
      text-align: center;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 16px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0B63F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    /* Results sections */
    .results {
      display: none;
      margin-top: 20px;
    }

    .results.active {
      display: block;
    }

    .result-section {
      margin-bottom: 24px;
    }

    .flow-list, .improvement-list, .pattern-list, .wcag-list, .notes-list {
      margin-left: 16px;
    }

    .flow-list li,
    .notes-list li {
      margin-bottom: 6px;
      color: #b0b0b0;
    }

    .improvement-item,
    .pattern-item,
    .wcag-item {
      background: #252525;
      border-left: 3px solid #0B63F6;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
    }

    .improvement-item h4,
    .pattern-item h4,
    .wcag-item h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #ffffff;
    }

    .improvement-item p,
    .pattern-item p,
    .wcag-item p {
      font-size: 12px;
      margin-bottom: 4px;
      color: #b0b0b0;
    }

    .component-tag {
      display: inline-block;
      background: #1a3a5a;
      color: #7ab8e8;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      margin-right: 4px;
      margin-top: 4px;
      font-family: 'Courier New', monospace;
    }

    .pattern-actions {
      margin-top: 8px;
    }

    .pattern-actions button {
      width: auto;
      padding: 6px 12px;
      font-size: 11px;
    }

    .error {
      background: #3a1a1a;
      border: 1px solid #8a4a4a;
      color: #ff8a80;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .error h4 {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Input Form -->
    <div id="input-section">
      <h2>Task Context</h2>

      <div id="selection-status" class="selection-status none">
        Detecting selection...
      </div>

      <label>Primary Task <span class="required">*</span></label>
      <input type="text" id="primaryTask" placeholder="e.g., User signs in" required>

      <label>Secondary Task</label>
      <input type="text" id="secondaryTask" placeholder="e.g., Reset password">

      <label>Persona</label>
      <input type="text" id="persona" placeholder="e.g., New desktop user">

      <label>Constraints</label>
      <textarea id="constraints" placeholder="e.g., Use Material Web components; minimal form"></textarea>

      <label>System Prompt (optional)</label>
      <textarea id="systemPrompt" placeholder="Custom instructions for the AI..."></textarea>

      <button id="captureBtn" class="secondary">üîÑ Refresh selection</button>
      <button id="analyzeBtn">üîç Analyze</button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Analyzing design...</div>
    </div>

    <!-- Error Display -->
    <div id="error" class="error hidden">
      <h4>Error</h4>
      <p id="errorMessage"></p>
    </div>

    <!-- Results -->
    <div id="results" class="results">
      <h2>Analysis Results</h2>

      <button id="addNotesBtn" class="secondary">üìù Add notes to canvas</button>

      <!-- User Flows -->
      <div class="result-section">
        <h3>User Flows</h3>
        <div id="flows-content"></div>
      </div>

      <!-- UX Improvements -->
      <div class="result-section">
        <h3>Top 5 UX Improvements</h3>
        <div id="improvements-content"></div>
      </div>

      <!-- Pattern Suggestions -->
      <div class="result-section">
        <h3>Pattern Suggestions</h3>
        <div id="patterns-content"></div>
      </div>

      <!-- WCAG Notes -->
      <div class="result-section">
        <h3>WCAG Accessibility Notes</h3>
        <div id="wcag-content"></div>
      </div>
    </div>
  </div>

  <script>
    console.log('[UI] ui.ts is loading...');

    // State
    let currentSnapshot = null;
    let currentResults = null;

    console.log('[UI] Waiting for DOM...');

    // DOM Elements
    let primaryTaskInput;
    let secondaryTaskInput;
    let personaInput;
    let constraintsInput;
    let systemPromptInput;
    let captureBtn;
    let analyzeBtn;
    let addNotesBtn;
    let selectionStatus;
    let inputSection;
    let loadingSection;
    let loadingText;
    let errorSection;
    let errorMessage;
    let resultsSection;
    let flowsContent;
    let improvementsContent;
    let patternsContent;
    let wcagContent;

    function initializeDOM() {
      console.log('[UI] Initializing DOM elements...');

      primaryTaskInput = document.getElementById('primaryTask');
      secondaryTaskInput = document.getElementById('secondaryTask');
      personaInput = document.getElementById('persona');
      constraintsInput = document.getElementById('constraints');
      systemPromptInput = document.getElementById('systemPrompt');
      captureBtn = document.getElementById('captureBtn');
      analyzeBtn = document.getElementById('analyzeBtn');
      addNotesBtn = document.getElementById('addNotesBtn');
      selectionStatus = document.getElementById('selection-status');
      inputSection = document.getElementById('input-section');
      loadingSection = document.getElementById('loading');
      loadingText = document.getElementById('loadingText');
      errorSection = document.getElementById('error');
      errorMessage = document.getElementById('errorMessage');
      resultsSection = document.getElementById('results');
      flowsContent = document.getElementById('flows-content');
      improvementsContent = document.getElementById('improvements-content');
      patternsContent = document.getElementById('patterns-content');
      wcagContent = document.getElementById('wcag-content');

      console.log('[UI] DOM elements initialized successfully');
    }

    function updateSelectionStatus(snapshot) {
      if (snapshot) {
        selectionStatus.className = 'selection-status';
        selectionStatus.textContent = `‚úì Captured: "${snapshot.title}" - ${snapshot.selectionSummary.nodeCount} nodes`;
      } else {
        selectionStatus.className = 'selection-status none';
        selectionStatus.textContent = 'No selection captured. Click "Use current selection" to capture your design.';
      }
    }

    function showLoading(message) {
      inputSection.style.display = 'none';
      resultsSection.classList.remove('active');
      errorSection.classList.add('hidden');
      loadingSection.classList.add('active');
      loadingText.textContent = message;
    }

    function hideLoading() {
      loadingSection.classList.remove('active');
      inputSection.style.display = 'block';
    }

    function showError(error) {
      hideLoading();
      errorSection.classList.remove('hidden');
      errorMessage.textContent = error;
    }

    function hideError() {
      errorSection.classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderFlows(flows) {
      let html = '';

      if (flows.primary.length > 0) {
        html += '<h4 style="font-size: 13px; margin-top: 10px; margin-bottom: 6px;">Primary Flow</h4>';
        html += '<ol class="flow-list">';
        flows.primary.forEach(step => {
          html += `<li>${escapeHtml(step)}</li>`;
        });
        html += '</ol>';
      }

      if (flows.secondary.length > 0) {
        html += '<h4 style="font-size: 13px; margin-top: 10px; margin-bottom: 6px;">Secondary Flow</h4>';
        html += '<ol class="flow-list">';
        flows.secondary.forEach(step => {
          html += `<li>${escapeHtml(step)}</li>`;
        });
        html += '</ol>';
      }

      if (flows.edgeCases.length > 0) {
        html += '<h4 style="font-size: 13px; margin-top: 10px; margin-bottom: 6px;">Edge Cases</h4>';
        html += '<ol class="flow-list">';
        flows.edgeCases.forEach(step => {
          html += `<li>${escapeHtml(step)}</li>`;
        });
        html += '</ol>';
      }

      flowsContent.innerHTML = html;
    }

    function renderImprovements(improvements) {
      let html = '';

      improvements.forEach((improvement, index) => {
        html += `
          <div class="improvement-item">
            <h4>${index + 1}. ${escapeHtml(improvement.title)}</h4>
            <p><strong>Why:</strong> ${escapeHtml(improvement.rationale)}</p>
            <p><strong>How to apply:</strong> ${escapeHtml(improvement.howToApply)}</p>
          </div>
        `;
      });

      improvementsContent.innerHTML = html;
    }

    function renderPatterns(patterns) {
      let html = '';

      patterns.forEach((pattern, index) => {
        const components = pattern.components || pattern.componentsHint || [];
        const rationale = pattern.rationale || pattern.why || '';

        html += `
          <div class="pattern-item">
            <h4>${escapeHtml(pattern.name)}</h4>
            <p>${escapeHtml(rationale)}</p>

            ${components.length > 0 ? `
              <div style="margin-top: 8px;">
                <strong style="font-size: 11px; color: #666;">Material Web Components:</strong><br>
                ${components.map(c => `<span class="component-tag">${escapeHtml(c)}</span>`).join('')}
              </div>
            ` : ''}

            <div class="pattern-actions">
              <button class="secondary" data-pattern-index="${index}">
                ‚ö° Insert wireframe placeholder
              </button>
            </div>
          </div>
        `;
      });

      patternsContent.innerHTML = html;

      patternsContent.querySelectorAll('button[data-pattern-index]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-pattern-index') || '0');
          const pattern = patterns[index];
          const components = pattern.components || pattern.componentsHint || [];

          parent.postMessage({
            pluginMessage: {
              type: 'insert-scaffold',
              patternName: pattern.name,
              components
            }
          }, '*');
        });
      });
    }

    function renderWCAG(wcagNotes) {
      let html = '';

      wcagNotes.forEach(note => {
        html += `
          <div class="wcag-item">
            <h4>‚ö†Ô∏è ${escapeHtml(note.issue)}</h4>
            <p><strong>Issue:</strong> ${escapeHtml(note.detail)}</p>
            <p><strong>Fix:</strong> ${escapeHtml(note.fix)}</p>
          </div>
        `;
      });

      wcagContent.innerHTML = html;
    }

    function displayResults(results) {
      currentResults = results;
      hideLoading();
      hideError();

      renderFlows(results.flows);
      renderImprovements(results.uxImprovements);
      renderPatterns(results.patterns);
      renderWCAG(results.wcagNotes);

      resultsSection.classList.add('active');
    }

    async function analyzeDesign() {
      const primaryTask = primaryTaskInput.value.trim();

      if (!primaryTask) {
        showError('Primary task is required');
        return;
      }

      hideError();
      showLoading('Analyzing design... This may take up to 15 seconds');

      const payload = {
        primaryTask,
        secondaryTask: secondaryTaskInput.value.trim() || undefined,
        persona: personaInput.value.trim() || undefined,
        constraints: constraintsInput.value.trim() || undefined,
        systemPrompt: systemPromptInput.value.trim() || undefined,
        frameSnapshot: currentSnapshot || undefined
      };

      console.log('[UI] Sending analyze request:', payload);

      try {
        const response = await fetch('http://localhost:4000/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }

        const results = await response.json();
        console.log('[UI] Analysis results received:', results);

        displayResults(results);
      } catch (error) {
        console.error('[UI] Analysis error:', error);
        showError(`Analysis failed: ${error.message || 'Unknown error'}. Make sure the backend server is running on localhost:4000.`);
      }
    }

    function setupEventListeners() {
      console.log('[UI] Setting up event listeners...');

      captureBtn.addEventListener('click', () => {
        console.log('[UI] Requesting selection capture');
        parent.postMessage({ pluginMessage: { type: 'capture-selection' } }, '*');
      });

      analyzeBtn.addEventListener('click', () => {
        analyzeDesign();
      });

      addNotesBtn.addEventListener('click', () => {
        if (currentResults && currentResults.canvasNotes.length > 0) {
          parent.postMessage({
            pluginMessage: {
              type: 'insert-notes',
              notes: currentResults.canvasNotes
            }
          }, '*');
        }
      });

      console.log('[UI] Event listeners set up successfully');
    }

    // Listen for messages from plugin code
    window.onmessage = (event) => {
      console.log('[UI] Message received:', event);
      const msg = event.data.pluginMessage;
      if (!msg) {
        console.log('[UI] No pluginMessage in event data');
        return;
      }

      console.log('[UI] Plugin message type:', msg.type);

      if (msg.type === 'selection-captured') {
        console.log('[UI] Selection captured, snapshot:', msg.snapshot);
        currentSnapshot = msg.snapshot;
        updateSelectionStatus(currentSnapshot);
      }
    };

    console.log('[UI] Setting up message listener...');

    // Initialize everything when DOM is ready
    if (document.readyState === 'loading') {
      console.log('[UI] DOM not ready yet, waiting...');
      document.addEventListener('DOMContentLoaded', () => {
        console.log('[UI] DOMContentLoaded fired');
        initializeDOM();
        setupEventListeners();
        console.log('[UI] UI fully initialized and listening for messages');
      });
    } else {
      console.log('[UI] DOM already ready');
      initializeDOM();
      setupEventListeners();
      console.log('[UI] UI fully initialized and listening for messages');
    }
  </script>
</body>
</html>
